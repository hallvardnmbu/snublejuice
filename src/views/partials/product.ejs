<section
  class="product"
  id="<%= index %>"
  index="<%= index %>"
  style="
    --color: <%=
      taxfree ?
        (item.taxfree.discount > 0 ? 'var(--negative)' :
        item.taxfree.discount < 0 ? 'var(--positive)' : 'var(--neutral)') :
        (item.discount > 0 ? 'var(--negative)' :
        item.discount < 0 ? 'var(--positive)' : 'var(--neutral)')
    %>;"
>
    <div>
        <h1>
            <a href="<%= taxfree ? item.taxfree.url : item.url %>" target="_blank"><%= item.name %></a>

            <% if (user) { %>
                <p
                    alt="Favoritt"
                    data-index="<%= item.index %>"
                    class="favourite-toggle"
                >
                    <%= user.favourites.includes(item.index) ? '★' : '☆' %>
                </p>
            <% } %>
        </h1>

        <span>
            <p><%= item.category %></p>
            <% if (item.subcategory) { %>
                <i><%= item.subcategory %></i>
            <% } %>
            <p>•</p>
            <p><%= item.alcohol %>% alk.</p>
        </span>

        <span>
            <p><%= item.country %></p>
            <% if (item.district) { %>
                <i><%= item.district %></i>
            <% } %>
            <% if (item.subdistrict) { %>
                <p><%= item.subdistrict %></p>
            <% } %>
        </span>

        <% if (storelike) { %>
        <span style="flex-direction: column;">
            <% const storeRegex = new RegExp(`(^|[^a-zæøåA-ZÆØÅ])${storelike}([^a-zæøåA-ZÆØÅ]|$)`, 'i') %>
            <% const matchingStores = item.stores.filter(store => storeRegex.test(store)) %>
            <% matchingStores.forEach((store, index) => { %>
            <p>• <%= store %></p>
            <% }) %>
        </span>
        <% } %>

        <% if (taxfree && item.taxfree.stores) { %>
        <span style="flex-direction: column;">
            <% const taxfreeStores = item.taxfree.stores.sort((a,b) => a.localeCompare(b)) %>
            <% taxfreeStores.forEach((store, index) => { %>
            <p>• <%= store %></p>
            <% }) %>
        </span>
        <% } %>

        <% if (item.rating && (item.rating.value !== undefined && item.rating.value !== null)) { %>
        <span>
            <% if (item.rating.url) { %>
                <a href="<%= item.rating.url %>"
                    class="rating"
                    target="_blank"
                    rel="noopener noreferrer"
                    onclick="event.stopPropagation()">
            <% } %>

            <% for (let i = 0; i < 5; i++) { %>
                <p class="star" style="--fill: <%=
                    i < Math.floor(item.rating.value) ? 100 :
                    i === Math.floor(item.rating.value) ? (item.rating.value - Math.floor(item.rating.value)) * 100 : 0
                %>%">★</p>
            <% } %>

            <p><b><%= item.rating.value %></b> av <b>5</b></p>

            <% if (item.rating.url) { %>
                </a>
            <% } %>
        </span>
        <% } %>

        <% if (item.description) { %>
            <span><%= item.description.lang %></span>
        <% } %>

        <div>
            <% if (taxfree) { %>
                <span><a href="<%= item.taxfree.url %>" target="_blank">TAX-FREE</a> <b><%= Math.ceil(item.taxfree.price) %></b></span>
                <span class="slim"><a href="<%= item.url %>" target="_blank">POLET</a> <b><%= Math.ceil(item.price) %></b></span>
                <span class="wide"><a href="<%= item.url %>" target="_blank">VINMONOPOLET</a> <b><%= Math.ceil(item.price) %></b></span>
                <span>DIFFERANSE <b><%= Math.floor(item.taxfree.discount) %>%</b></span>
                <span class="wide">KR/L <b><%= Math.ceil(item.literprice) %></b></span>
            <% } else { %>
                <span>KR <b><%= Math.ceil(item.price) %></b></span>

                <% if (item.oldprice) { %>
                    <span>FØR <b><%= Math.ceil(item.oldprice) %></b></span>
                    <span>ENDRING <b><%= Math.floor(item.discount) %>%</b></span>
                <% } %>

                <span>KR/L <b><%= Math.ceil(item.literprice) %></b></span>
            <% } %>
        </div>

        <span><a class="expand" index="<%= index %>">Vis meg mere!</a></span>

        <svg class="path" viewBox="0 0 0 0" preserveAspectRatio="none">
            <path
                id="path-<%= index %>"
                d=""
                data-prices='<%= JSON.stringify(taxfree ? item.taxfree.prices : item.prices) %>'
            ></path>
        </svg>
    </div>

    <%- include('detailed', { taxfree: taxfree, item: item, index: index }) %>

</section>
